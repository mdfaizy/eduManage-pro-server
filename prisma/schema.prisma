generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
}

/////////////////////////////
// üîì PUBLIC / SYSTEM LEVEL
/////////////////////////////

model School {
  id     Int          @id @default(autoincrement())
  name   String
  email  String       @unique
  phone  String?
  status SchoolStatus @default(PENDING)
  sections  Section[] 
  subscriptions SchoolSubscription[]
  users         User[]
   teachers      Teacher[]      
   timetables Timetable[]
     timings SchoolTiming[]
     periods       Period[]
     days Day[]
     academicYears AcademicYear[]
 
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum SchoolStatus {
  PENDING
  ACTIVE
  BLOCKED
}

model Plan {
  id       Int    @id @default(autoincrement())
  name     String @unique
  price    Float
  duration Int // days
  features Json // ["ATTENDANCE","FEES","EXAMS"]

  subscriptions SchoolSubscription[]
  createdAt DateTime @default(now())
updatedAt DateTime @updatedAt

}

model SchoolSubscription {
  id        Int                @id @default(autoincrement())
  schoolId  Int
  planId    Int
  startDate DateTime
  endDate   DateTime
  status    SubscriptionStatus

  school School @relation(fields: [schoolId], references: [id])
  plan   Plan   @relation(fields: [planId], references: [id])
  createdAt DateTime @default(now())
updatedAt DateTime @updatedAt

}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}

model SchoolRequest {
  id         Int           @id @default(autoincrement())
  schoolName String
  email      String
  phone      String
  status     RequestStatus @default(PENDING)
  createdAt DateTime @default(now())
updatedAt DateTime @updatedAt

}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

model Transaction {
  id        Int           @id @default(autoincrement())
  schoolId  Int
  amount    Float
  gateway   String
  reference String
  status    PaymentStatus
  createdAt DateTime      @default(now())
}

enum PaymentStatus {
  SUCCESS
  FAILED
  PENDING
}

/////////////////////////////
// üîê AUTH & RBAC
/////////////////////////////

model User {
  id            Int     @id @default(autoincrement())
  name          String
  email         String  @unique
  password      String
  isActive      Boolean @default(true)
  emailVerified Boolean @default(false)

  schoolId Int?
  school   School? @relation(fields: [schoolId], references: [id])

  roles  UserRole[]
  tokens Token[]
  teacher Teacher?  
  userPermissions UserPermission[]   
  createdAt DateTime @default(now())
updatedAt DateTime @updatedAt

}

model Teacher {
  id       Int @id @default(autoincrement())
  userId   Int
  schoolId Int
  teacherCode   String   @unique
  phone         String?
  gender        String?
  joiningDate   DateTime?
  qualification String?
  user     User   @relation(fields: [userId], references: [id])
  school   School @relation(fields: [schoolId], references: [id])
  classTeachers   ClassTeacher[]
  teacherSubjects TeacherSubject[]

  timetables         Timetable[]  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId])
  
}

model Role {
  id       Int    @id @default(autoincrement())
  name     String
  schoolId Int?
  profileType String? 
  users       UserRole[]
  permissions RolePermission[]
  createdAt DateTime @default(now())
updatedAt DateTime @updatedAt

  @@unique([name, schoolId])
}

model Permission {
  id          Int              @id @default(autoincrement())
  key         String           @unique
  description String?
  roles       RolePermission[]
  userPermissions  UserPermission[]
  createdAt DateTime @default(now())
updatedAt DateTime @updatedAt
 
}

model UserRole {
  userId Int
  roleId Int

  user User @relation(fields: [userId], references: [id])
  role Role @relation(fields: [roleId], references: [id])

  @@id([userId, roleId])
}
model UserPermission {
  id           Int        @id @default(autoincrement())
  userId       Int
  permissionId Int
  granted      Boolean    @default(true)

  user         User       @relation(fields: [userId], references: [id])
  permission   Permission @relation(fields: [permissionId], references: [id])

  @@unique([userId, permissionId])
}

model RolePermission {
  roleId       Int
  permissionId Int

  role       Role       @relation(fields: [roleId], references: [id])
  permission Permission @relation(fields: [permissionId], references: [id])

  @@id([roleId, permissionId])
}

model Token {
  id        Int      @id @default(autoincrement())
  userId    Int
  tokenHash String   @unique
  type      TokenType
  expiresAt DateTime
  isUsed    Boolean  @default(false)
  isRevoked Boolean  @default(false)
  userAgent String?
  ipAddress String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, type])
}



enum TokenType {
  ACCESS
  REFRESH
  RESET_PASSWORD
  VERIFY_EMAIL
  SET_PASSWORD  
}

/////////////////////////////
// üéì ACADEMIC
/////////////////////////////
model Class {
  id          Int    @id @default(autoincrement())
  name        String
  gradeId     Int
  schoolId    Int
  description String?
  maxStudents Int?

  isActive    Boolean @default(true)
  isDeleted   Boolean @default(false)

  grade       Grade @relation(fields: [gradeId], references: [id])
  sections    Section[]
  syllabi     Syllabus[]
  classTeachers ClassTeacher[]
  teacherSubjects TeacherSubject[] 
  timetables Timetable[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name, schoolId])
}
model Section {
  id        Int    @id @default(autoincrement())
  name      String
  classId   Int
  schoolId  Int
  capacity    Int?  
  description String?
  isActive  Boolean @default(true)
  class     Class  @relation(fields: [classId], references: [id])
  school    School   @relation(fields: [schoolId], references: [id]) 
  students  Student[] 
  classTeachers ClassTeacher[]
  teacherSubjects TeacherSubject[]
  timetables Timetable[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // @@unique([name, classId])
  @@unique([schoolId, name, classId])

}
model Grade {
  id        Int    @id @default(autoincrement())
  name      String
  schoolId  Int
  description String?
  isActive  Boolean @default(true)
  isDeleted Boolean @default(false)
  classes   Class[]
  syllabi   Syllabus[]
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  @@unique([name, schoolId])
}
model Subject {
  id        Int    @id @default(autoincrement())
  name      String
  description String?
  isActive  Boolean @default(true)
  schoolId  Int
  code      String  @unique
  syllabi   Syllabus[] 
  teacherSubjects TeacherSubject[]
  timetables Timetable[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Syllabus {
  id        Int @id @default(autoincrement())
  subjectId Int
  gradeId   Int?
  classId   Int?
  schoolId  Int
  description String?
  type      SubjectType @default(CORE)
  chapters  Json
  maxMarks  Int?
  passMarks Int?
  isActive  Boolean @default(true)
  isDeleted Boolean @default(false)
  subject   Subject @relation(fields: [subjectId], references: [id])
  grade     Grade?  @relation(fields: [gradeId], references: [id])
  class     Class?  @relation(fields: [classId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([subjectId, gradeId, classId, schoolId])
}


enum SubjectType {
  CORE
  EXTRA
}
model ClassTeacher {
  id        Int @id @default(autoincrement())

  teacherId Int
  classId   Int
  sectionId Int

  teacher Teacher @relation(fields: [teacherId], references: [id])
  class   Class   @relation(fields: [classId], references: [id])
  section Section @relation(fields: [sectionId], references: [id])

  createdAt DateTime @default(now())

  // ‚≠ê ek class + section ka sirf 1 class teacher
  @@unique([classId, sectionId])
}
model Day {
  id         Int @id @default(autoincrement())
  schoolId   Int
  name       String
  shortName  String
  order      Int
  maxPeriods Int
  isActive   Boolean @default(true)
  isHalfDay  Boolean @default(false)
  timetables Timetable[]

  school School @relation(fields:[schoolId], references:[id])
  periods Period[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, name])
}


model TeacherSubject {
  id        Int @id @default(autoincrement())

  teacherId Int
  subjectId Int
  classId   Int
  sectionId Int
  // schoolId Int

  teacher Teacher @relation(fields: [teacherId], references: [id])
  subject Subject @relation(fields: [subjectId], references: [id])
  class   Class   @relation(fields: [classId], references: [id])
  section Section @relation(fields: [sectionId], references: [id])

  // ‚≠ê same subject same class same section duplicate nahi
  // @@unique([teacherId, subjectId, classId, sectionId])
  // @@unique([schoolId, teacherId, subjectId, classId, sectionId])

}
model SchoolTiming {
  id           Int      @id @default(autoincrement())
  schoolId     Int
  academicYear String

  type         TimingType @default(REGULAR)

  school       School   @relation(fields: [schoolId], references: [id])

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([schoolId, academicYear, type])
}

enum TimingType {
  REGULAR
  WINTER
  RAMADAN
  EXAM
}

model Period {
  id           Int      @id @default(autoincrement())
  schoolId     Int
  academicYearId Int
 timingType TimingType @default(REGULAR)

  dayId        Int
  periodNumber Int

  startTime    String
  endTime      String

  isBreak      Boolean  @default(false)
  isActive     Boolean  @default(true)

  school       School   @relation(fields: [schoolId], references: [id])
  day          Day      @relation(fields: [dayId], references: [id])
  timetables   Timetable[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([schoolId, academicYearId, dayId, periodNumber])
@@index([schoolId, academicYearId])

}

model AcademicYear {
  id        Int      @id @default(autoincrement())
  schoolId  Int
  name      String
  startDate DateTime
  endDate   DateTime
  isActive  Boolean  @default(false)

  school    School @relation(fields: [schoolId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, name])
}

model Timetable {
  id             Int      @id @default(autoincrement())

  schoolId       Int
  classId        Int
  sectionId      Int
  subjectId      Int
  teacherId      Int

  dayId          Int
  periodId       Int
  academicYearId Int

 startTime String
  endTime   String
//   effectiveFrom DateTime
// effectiveTo   DateTime?

  school   School   @relation(fields: [schoolId], references: [id])
  class    Class    @relation(fields: [classId], references: [id])
  section  Section  @relation(fields: [sectionId], references: [id])
  subject  Subject  @relation(fields: [subjectId], references: [id])
  teacher  Teacher  @relation(fields: [teacherId], references: [id])
  period   Period   @relation(fields: [periodId], references: [id])
  day      Day      @relation(fields: [dayId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sectionId, dayId, periodId, academicYearId])
  @@unique([teacherId, dayId, periodId, academicYearId])
//   @@unique([schoolId, sectionId, dayId, periodId, academicYearId, effectiveFrom])
// @@unique([schoolId, teacherId, dayId, periodId, academicYearId, effectiveFrom])

 
  @@index([schoolId, academicYearId])
}




// enum DayOfWeek {
//   MONDAY
//   TUESDAY
//   WEDNESDAY
//   THURSDAY
//   FRIDAY
//   SATURDAY
// }



/////////////////////////////
// üë®‚Äçüéì STUDENTS & PARENTS
/////////////////////////////

model Student {
  id        Int @id @default(autoincrement())
  userId    Int
  schoolId  Int
  classId   Int
  sectionId Int?
  section   Section? @relation(fields: [sectionId], references: [id])
  
}

model Parent {
  id       Int @id @default(autoincrement())
  userId   Int
  schoolId Int
}

model StudentParent {
  studentId Int
  parentId  Int

  @@id([studentId, parentId])
}

model Admission {
  id           Int    @id @default(autoincrement())
  studentId    Int
  schoolId     Int
  classId      Int
  sectionId    Int?
  academicYear String

  status    AdmissionStatus
  startDate DateTime        @default(now())
  endDate   DateTime?

  reason      String? // cancel / transfer reason
  cancelledBy Int? // userId (admin)

  createdAt DateTime @default(now())
}

enum AdmissionStatus {
  ACTIVE
  CANCELLED
  TRANSFERRED
  COMPLETED
}

/////////////////////////////
// üìã ATTENDANCE (ADVANCED)
/////////////////////////////

model AttendanceSession {
  id        Int      @id @default(autoincrement())
  schoolId  Int
  classId   Int
  sectionId Int?
  teacherId Int
  date      DateTime

  records AttendanceRecord[]

  @@unique([classId, sectionId, date])
}

model AttendanceRecord {
  id        Int              @id @default(autoincrement())
  sessionId Int
  studentId Int
  status    AttendanceStatus

  session AttendanceSession @relation(fields: [sessionId], references: [id])
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  HALF_DAY
}

/////////////////////////////
// üë©‚Äçüè´ TEACHERS & STAFF
/////////////////////////////
model Staff {
  id            Int @id @default(autoincrement())
  userId        Int
  schoolId      Int
  designationId Int
}

model Designation {
  id   Int    @id @default(autoincrement())
  name String
}

model Payroll {
  id      Int    @id @default(autoincrement())
  staffId Int
  salary  Float
  month   String
}

/////////////////////////////
// üí∞ FEES & PAYMENTS
/////////////////////////////

model FeeStructure {
  id      Int   @id @default(autoincrement())
  classId Int
  amount  Float
}

model StudentFee {
  id        Int   @id @default(autoincrement())
  studentId Int
  dueAmount Float
}

model Invoice {
  id     Int           @id @default(autoincrement())
  amount Float
  status InvoiceStatus
}

enum InvoiceStatus {
  PAID
  UNPAID
}

model PaymentReceipt {
  id        Int   @id @default(autoincrement())
  invoiceId Int
  amount    Float
}

/////////////////////////////
// üìù EXAMS & RESULTS
/////////////////////////////

model Exam {
  id      Int    @id @default(autoincrement())
  name    String
  classId Int
}

model ExamSchedule {
  id     Int      @id @default(autoincrement())
  examId Int
  date   DateTime
}

model Mark {
  id        Int   @id @default(autoincrement())
  examId    Int
  studentId Int
  marks     Float
}

model Result {
  id        Int   @id @default(autoincrement())
  studentId Int
  total     Float
}

/////////////////////////////
// üßæ AUDIT LOG (ENTERPRISE)
/////////////////////////////

model AuditLog {
  id        Int      @id @default(autoincrement())
  userId    Int
  action    String
  entity    String
  entityId  Int?
  createdAt DateTime @default(now())
}
